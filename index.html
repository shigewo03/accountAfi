<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter管理ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
            margin: 0;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #0056b3;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Twitter Search Tool Styles */
        .twitter-tool input[type="text"] {
            padding: 10px;
            font-size: 16px;
            width: calc(100% - 22px);
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .twitter-tool button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .twitter-tool button:hover {
            background-color: #0056b3;
        }
        .twitter-tool ul {
            padding-left: 20px;
            list-style-type: none;
        }
        .twitter-tool li {
            margin: 5px 0;
        }
        .twitter-tool a {
            color: #007bff;
            text-decoration: none;
        }
        /* Affiliate Tool Styles */
        .affiliate-tool .account-card {
            border: 1px solid #ccc;
            padding: 12px;
            margin: 10px;
            border-radius: 10px;
        }
        .affiliate-tool .admin-section {
            margin-bottom: 30px;
        }
        .affiliate-tool .input-group {
            margin: 6px 0;
        }
        .affiliate-tool label {
            display: inline-block;
            width: 80px;
        }
        .affiliate-tool input[type="text"],
        .affiliate-tool input[type="number"] {
            width: 200px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .affiliate-tool button {
            margin: 5px;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .affiliate-tool button:hover {
            background-color: #45a049;
        }
        .affiliate-tool canvas {
            max-width: 100%;
            height: 300px;
        }
        .affiliate-tool .filter button {
            background-color: #4caf50;
        }
        .affiliate-tool .filter button:hover {
            background-color: #45a049;
        }
        .affiliate-tool .edit-inline input {
            width: 100%;
            margin: 4px 0;
        }
        .affiliate-tool .deleted-section {
            background: #eee;
            padding: 10px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .affiliate-tool .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .affiliate-tool .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        .affiliate-tool .modal-content input {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .affiliate-tool .modal-content button {
            margin: 5px 3px;
        }
        .affiliate-tool .chart-toggle {
            margin: 10px 0;
        }
        /* 追加スタイル：チャートボタンの状態を明確化 */
        .chart-toggle button {
            background-color: #4caf50;
            transition: background-color 0.3s;
        }
        .chart-toggle button.off {
            background-color: #ccc;
        }
        .account-card button.chart-button {
            background-color: #4caf50;
            transition: background-color 0.3s;
        }
        .account-card button.chart-button.off {
            background-color: #ccc;
        }
        .account-card button.chart-button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Twitter管理ツール</h1>
    <div class="tabs">
        <div class="tab active" onclick="showTab('twitter-tool')">Twitter ID検索</div>
        <div class="tab" onclick="showTab('affiliate-tool')">アダアフィ管理</div>
    </div>

    <!-- Twitter ID Search Tool -->
    <div id="twitter-tool" class="tab-content twitter-tool active">
        <h2>Twitter ID ワンタップ検索ツール</h2>
        <input type="text" id="twitterID" placeholder="Twitter IDを入力" />
        <button onclick="addUser()">IDを追加</button>
        <h3>登録されたID一覧</h3>
        <ul id="userList"></ul>
        <h3>検索リンク</h3>
        <ul id="searchLinks"></ul>
    </div>

    <!-- Affiliate Account Management Tool -->
    <div id="affiliate-tool" class="tab-content affiliate-tool">
        <h2>アダアフィアカウント管理ツール</h2>
        <div class="chart-toggle">
            <button id="global-chart-toggle" onclick="affiliate.toggleCharts()">📊 全体チャート表示</button>
        </div>
        <!-- アカウント追加フォーム -->
        <div>
            <h3>アカウント追加</h3>
            <div class="input-group">
                <label>名前:</label><input type="text" id="name">
                <label>@ID:</label><input type="text" id="handle">
            </div>
            <div class="input-group">
                <label>URL:</label><input type="text" id="url">
                <label>運用者:</label><input type="text" id="manager">
            </div>
            <button onclick="addAccount()">アカウントを追加</button>
        </div>
        <!-- フィルター -->
        <div class="filter">
            <button onclick="setFilter('7')">1週間</button>
            <button onclick="setFilter('30')">1ヶ月</button>
            <button onclick="setFilter('365')">1年</button>
            <button onclick="setFilter('all')">全て</button>
        </div>
        <!-- アカウントリスト -->
        <div id="account-list"></div>
        <!-- 削除済みアカウント -->
        <div class="deleted-section">
            <h3>🗑️ 削除済みアカウント一覧</h3>
            <div id="deleted-list"></div>
        </div>
        <!-- 詳細情報編集モーダル -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <h3>詳細情報の編集</h3>
                <input type="text" id="modal-twitter_id" placeholder="Twitter ID">
                <input type="text" id="modal-password" placeholder="パスワード">
                <input type="text" id="modal-email" placeholder="メールアドレス">
                <input type="text" id="modal-twofa" placeholder="2FA">
                <input type="text" id="modal-backup" placeholder="バックアップコード">
                <input type="text" id="modal-phone" placeholder="電話番号">
                <input type="text" id="modal-token" placeholder="トークンキー">
                <button onclick="saveModal()">💾 保存</button>
                <button onclick="closeModal()">キャンセル</button>
            </div>
        </div>
        <!-- 運用者変更モーダル -->
        <div id="manager-modal" class="modal">
            <div class="modal-content">
                <h3>運用者変更</h3>
                <input type="text" id="modal-new-manager" placeholder="新しい運用者名">
                <button onclick="saveManagerChange()">💾 保存</button>
                <button onclick="closeManagerModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // Twitter ID Search Tool Scripts
        const twitter = {
            userList: JSON.parse(localStorage.getItem("twitterUserList")) || [],
            loadUserList() {
                return this.userList;
            },
            addUser() {
                const twitterID = document.getElementById("twitterID").value.trim();
                if (twitterID && !this.userList.includes(twitterID)) {
                    this.userList.push(twitterID);
                    localStorage.setItem("twitterUserList", JSON.stringify(this.userList));
                    document.getElementById("twitterID").value = "";
                    this.displayUserList();
                }
            },
            deleteUser(twitterID) {
                const index = this.userList.indexOf(twitterID);
                if (index > -1) {
                    this.userList.splice(index, 1);
                    localStorage.setItem("twitterUserList", JSON.stringify(this.userList));
                    this.displayUserList();
                }
            },
            displayUserList() {
                const userListElement = document.getElementById("userList");
                const searchLinksElement = document.getElementById("searchLinks");
                userListElement.innerHTML = '';
                searchLinksElement.innerHTML = '';
                this.userList.forEach(user => {
                    const listItem = document.createElement("li");
                    listItem.innerText = `@${user}`;
                    const deleteButton = document.createElement("button");
                    deleteButton.innerText = "削除";
                    deleteButton.onclick = () => this.deleteUser(user);
                    listItem.appendChild(deleteButton);
                    userListElement.appendChild(listItem);
                    const searchLink = document.createElement("li");
                    const link = document.createElement("a");
                    link.href = `https://twitter.com/search?q=from:${user}`;
                    link.target = "_blank";
                    link.innerText = `🔍 from:${user}`;
                    searchLink.appendChild(link);
                    searchLinksElement.appendChild(searchLink);
                });
            }
        };
        twitter.displayUserList();

        // Affiliate Account Management Tool Scripts
        const affiliate = {
            accounts: JSON.parse(localStorage.getItem("accounts") || "[]"),
            deletedAccounts: JSON.parse(localStorage.getItem("deletedAccounts") || "[]"),
            filterDays: 'all',
            currentEditId: null,
            chartsVisible: true,
            saveData() {
                localStorage.setItem("accounts", JSON.stringify(this.accounts));
                localStorage.setItem("deletedAccounts", JSON.stringify(this.deletedAccounts));
            },
            toggleCharts() {
                this.chartsVisible = !this.chartsVisible;
                const toggleButton = document.getElementById("global-chart-toggle");
                toggleButton.innerText = this.chartsVisible ? "📊 全体チャート非表示" : "📊 全体チャート表示";
                toggleButton.classList.toggle("off", !this.chartsVisible);
                this.render();
            },
            toggleAccountChart(id) {
                const acc = this.accounts.find(a => a.id === id);
                if (acc && this.chartsVisible) {
                    acc.chartVisible = !acc.chartVisible;
                    this.saveData();
                    this.render();
                }
            },
            addAccount() {
                const name = document.getElementById("name").value.trim();
                const handle = document.getElementById("handle").value.trim();
                const url = document.getElementById("url").value.trim();
                const manager = document.getElementById("manager").value.trim();
                if (!name || !handle || !manager) return alert("必須項目が空です");
                const id = Date.now().toString();
                this.accounts.push({
                    id, name, handle, url, manager,
                    records: [],
                    twitter_id: '', password: '', email: '',
                    twofa: '', backup: '', phone: '', token: '',
                    chartVisible: true
                });
                this.saveData();
                document.getElementById("name").value = "";
                document.getElementById("handle").value = "";
                document.getElementById("url").value = "";
                document.getElementById("manager").value = "";
                this.render();
            },
            deleteAccount(id) {
                if (!confirm("このアカウントを削除しますか？")) return;
                const acc = this.accounts.find(a => a.id === id);
                this.deletedAccounts.push(acc);
                this.accounts = this.accounts.filter(a => a.id !== id);
                this.saveData();
                this.render();
            },
            restoreAccount(id) {
                const acc = this.deletedAccounts.find(a => a.id === id);
                this.accounts.push(acc);
                this.deletedAccounts = this.deletedAccounts.filter(a => a.id !== id);
                this.saveData();
                this.render();
            },
            deleteAccountPermanently(id) {
                if (!confirm("完全に削除しますか？")) return;
                this.deletedAccounts = this.deletedAccounts.filter(a => a.id !== id);
                this.saveData();
                this.render();
            },
            deleteManager(managerName) {
                if (!confirm(`${managerName}を削除しますか？\n（関連アカウントも削除されます）`)) return;
                const toDelete = this.accounts.filter(a => a.manager === managerName);
                this.deletedAccounts.push(...toDelete);
                this.accounts = this.accounts.filter(a => a.manager !== managerName);
                this.saveData();
                this.render();
            },
            addFollowerRecord(id) {
                const value = parseInt(prompt("今日のフォロワー数を入力してください"));
                if (isNaN(value)) return;
                const account = this.accounts.find(a => a.id === id);
                const today = new Date().toISOString().split("T")[0];
                const existing = account.records.find(r => r.date === today);
                if (existing) {
                    if (!confirm("すでに今日の記録があります。上書きしますか？")) return;
                    existing.value = value;
                } else {
                    account.records.push({ date: today, value });
                }
                this.saveData();
                this.render();
            },
            editInline(id) {
                const card = document.getElementById(`card-${id}`);
                const acc = this.accounts.find(a => a.id === id);
                card.innerHTML = `
                    <div class="edit-inline">
                        <input type="text" value="${acc.name}" id="edit-name-${id}">
                        <input type="text" value="${acc.handle}" id="edit-handle-${id}">
                        <input type="text" value="${acc.url}" id="edit-url-${id}">
                        <button onclick="affiliate.saveInlineEdit('${id}')">💾 保存</button>
                        <button onclick="affiliate.render()">キャンセル</button>
                    </div>
                `;
            },
            saveInlineEdit(id) {
                const acc = this.accounts.find(a => a.id === id);
                acc.name = document.getElementById(`edit-name-${id}`).value;
                acc.handle = document.getElementById(`edit-handle-${id}`).value;
                acc.url = document.getElementById(`edit-url-${id}`).value;
                this.saveData();
                this.render();
            },
            setFilter(days) {
                this.filterDays = days;
                this.render();
            },
            openModal(id) {
                this.currentEditId = id;
                const acc = this.accounts.find(a => a.id === id);
                document.getElementById("modal-twitter_id").value = acc.twitter_id;
                document.getElementById("modal-password").value = acc.password;
                document.getElementById("modal-email").value = acc.email;
                document.getElementById("modal-twofa").value = acc.twofa;
                document.getElementById("modal-backup").value = acc.backup;
                document.getElementById("modal-phone").value = acc.phone;
                document.getElementById("modal-token").value = acc.token;
                document.getElementById("modal").style.display = "flex";
            },
            closeModal() {
                this.currentEditId = null;
                document.getElementById("modal").style.display = "none";
            },
            saveModal() {
                const acc = this.accounts.find(a => a.id === this.currentEditId);
                acc.twitter_id = document.getElementById("modal-twitter_id").value;
                acc.password = document.getElementById("modal-password").value;
                acc.email = document.getElementById("modal-email").value;
                acc.twofa = document.getElementById("modal-twofa").value;
                acc.backup = document.getElementById("modal-backup").value;
                acc.phone = document.getElementById("modal-phone").value;
                acc.token = document.getElementById("modal-token").value;
                this.saveData();
                this.closeModal();
                this.render();
            },
            openManagerModal(id) {
                this.currentEditId = id;
                document.getElementById("modal-new-manager").value = '';
                document.getElementById("manager-modal").style.display = "flex";
            },
            closeManagerModal() {
                this.currentEditId = null;
                document.getElementById("manager-modal").style.display = "none";
            },
            saveManagerChange() {
                const newManager = document.getElementById("modal-new-manager").value.trim();
                if (!newManager) {
                    alert("運用者名を入力してください");
                    return;
                }
                const acc = this.accounts.find(a => a.id === this.currentEditId);
                acc.manager = newManager;
                this.saveData();
                this.closeManagerModal();
                this.render();
            },
            render() {
                const group = {};
                this.accounts.forEach(acc => {
                    if (!group[acc.manager]) group[acc.manager] = [];
                    group[acc.manager].push(acc);
                });
                const allManagers = new Set(this.accounts.map(a => a.manager).concat(this.deletedAccounts.map(a => a.manager)));
                const list = document.getElementById("account-list");
                list.innerHTML = "";
                for (const manager of allManagers) {
                    const section = document.createElement("div");
                    section.className = "admin-section";
                    section.innerHTML = `<h3>運用者: ${manager} <button onclick="affiliate.deleteManager('${manager}')">運用者を削除</button></h3>`;
                    const accs = group[manager] || [];
                    if (accs.length === 0) {
                        section.innerHTML += "<p>（アカウントなし）</p>";
                    }
                    accs.forEach(acc => {
                        const div = document.createElement("div");
                        div.className = "account-card";
                        div.id = `card-${acc.id}`;
                        div.innerHTML = `
                            <strong>${acc.name}</strong>（@${acc.handle}）<br>
                            <a href="${acc.url}" target="_blank">${acc.url}</a><br>
                            運用者: ${acc.manager}<br>
                            <button onclick="affiliate.addFollowerRecord('${acc.id}')">📈 フォロワー追加</button>
                            <button onclick="affiliate.openModal('${acc.id}')">⚙️ 詳細情報</button>
                            <button onclick="affiliate.editInline('${acc.id}')">✏️ 編集</button>
                            <button onclick="affiliate.openManagerModal('${acc.id}')">👤 運用者変更</button>
                            <button onclick="affiliate.deleteAccount('${acc.id}')">🗑️ 削除</button>
                            <button class="chart-button${!acc.chartVisible ? ' off' : ''}${!this.chartsVisible ? ' disabled' : ''}" 
                                    onclick="affiliate.toggleAccountChart('${acc.id}')" 
                                    ${!this.chartsVisible ? 'disabled' : ''}>
                                📊 チャート${acc.chartVisible ? '非表示' : '表示'}
                            </button>
                            <canvas id="chart-${acc.id}" style="display: ${this.chartsVisible && acc.chartVisible ? 'block' : 'none'};"></canvas>
                        `;
                        section.appendChild(div);
                        if (this.chartsVisible && acc.chartVisible) {
                            setTimeout(() => this.drawChart(acc), 10);
                        }
                    });
                    list.appendChild(section);
                }
                const dlist = document.getElementById("deleted-list");
                dlist.innerHTML = "";
                this.deletedAccounts.forEach(acc => {
                    const div = document.createElement("div");
                    div.className = "account-card";
                    div.innerHTML = `
                        <strong>${acc.name}</strong>（@${acc.handle}） - ${acc.manager}<br>
                        <button onclick="affiliate.restoreAccount('${acc.id}')">↩️ 復元</button>
                        <button onclick="affiliate.deleteAccountPermanently('${acc.id}')">❌ 完全削除</button>
                    `;
                    dlist.appendChild(div);
                });
                // 全体チャートボタンの状態を更新
                const toggleButton = document.getElementById("global-chart-toggle");
                toggleButton.innerText = this.chartsVisible ? "📊 全体チャート非表示" : "📊 全体チャート表示";
                toggleButton.classList.toggle("off", !this.chartsVisible);
            },
            drawChart(account) {
                const ctx = document.getElementById(`chart-${account.id}`);
                if (!ctx) return;
                const sorted = account.records.slice().sort((a, b) => a.date.localeCompare(b.date));
                const now = new Date();
                const filtered = sorted.filter(r => {
                    if (this.filterDays === 'all') return true;
                    const date = new Date(r.date);
                    const diff = (now - date) / (1000 * 60 * 60 * 24);
                    return diff <= parseInt(this.filterDays);
                });
                const labels = filtered.map(r => r.date);
                const data = filtered.map(r => r.value);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'フォロワー数',
                            data,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        };
        affiliate.render();

        // Global function bindings for HTML onclick events
        function addUser() { twitter.addUser(); }
        function addAccount() { affiliate.addAccount(); }
        function setFilter(days) { affiliate.setFilter(days); }
        function saveModal() { affiliate.saveModal(); }
        function closeModal() { affiliate.closeModal(); }
        function saveManagerChange() { affiliate.saveManagerChange(); }
        function closeManagerModal() { affiliate.closeManagerModal(); }
    </script>
</body>
</html>
